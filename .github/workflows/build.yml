name: Build HiveOS Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libuv1-dev git

      - name: Build XMRig (static)
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_TLS=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_CUDA=OFF \
            -DWITH_HWLOC=OFF \
            -DCMAKE_EXE_LINKER_FLAGS="-static"
          make -j$(nproc)

      - name: Verify static binary
        run: |
          BINARY=$(find build -maxdepth 1 -name "xmrig*" -type f -executable | head -1)
          echo "=== file ==="
          file "$BINARY"
          echo "=== ldd ==="
          ldd "$BINARY" 2>&1 || echo "(expected: not a dynamic executable)"
          echo "=== size ==="
          ls -lh "$BINARY"

      - name: Find and strip binary
        run: |
          # Binary may be named xmrig or xmrig-notls depending on TLS config
          BINARY=$(find build -maxdepth 1 -name "xmrig*" -type f -executable | head -1)
          echo "Found binary: $BINARY"
          strip "$BINARY"
          # Rename to standard name
          cp "$BINARY" build/xmrig
          ls -lh build/xmrig

      - name: Prepare HiveOS package
        run: |
          PKG_NAME="xmrig-tari"
          PKG_DIR="package/$PKG_NAME"
          mkdir -p "$PKG_DIR"
          
          # Copy binary
          cp build/xmrig "$PKG_DIR/xmrig"
          chmod +x "$PKG_DIR/xmrig"
          
          # Copy HiveOS integration scripts
          cp hiveos/h-manifest.conf "$PKG_DIR/"
          cp hiveos/h-run.sh "$PKG_DIR/"
          cp hiveos/h-stats.sh "$PKG_DIR/"
          cp hiveos/h-config.sh "$PKG_DIR/"
          
          # Force LF line endings (safety net)
          sed -i 's/\r$//' "$PKG_DIR"/*.sh "$PKG_DIR"/*.conf
          
          chmod +x "$PKG_DIR"/*.sh
          
          # Verify scripts parse correctly
          bash -n "$PKG_DIR/h-run.sh" && echo "h-run.sh: syntax OK" || exit 1
          bash -n "$PKG_DIR/h-stats.sh" && echo "h-stats.sh: syntax OK" || exit 1
          
          # Create the tar.gz
          cd package
          tar -czf "${PKG_NAME}.tar.gz" "$PKG_NAME"
          
          echo "Package contents:"
          tar -tzf "${PKG_NAME}.tar.gz"
          echo ""
          ls -lh "${PKG_NAME}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-tari-hiveos
          path: package/xmrig-tari.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: package/xmrig-tari.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install libuv via vcpkg
        run: |
          vcpkg install libuv:x64-windows-release
          echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake"

      - name: Build XMRig (Windows)
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-release `
            -DWITH_TLS=OFF -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DWITH_HWLOC=OFF
          cmake --build . --config Release

      - name: Package Windows build
        run: |
          mkdir package
          $bin = Get-ChildItem build\Release\xmrig*.exe | Select-Object -First 1
          Copy-Item $bin.FullName package\xmrig-tari.exe

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-tari-windows
          path: package/xmrig-tari.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: package/xmrig-tari.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
