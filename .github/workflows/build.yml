name: Build HiveOS Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libuv1-dev git autoconf automake libtool

      - name: Build hwloc static (minimal, no udev/pci/xml)
        run: |
          HWLOC_VER=2.9.3
          wget -q "https://download.open-mpi.org/release/hwloc/v2.9/hwloc-${HWLOC_VER}.tar.gz"
          tar xzf "hwloc-${HWLOC_VER}.tar.gz"
          cd "hwloc-${HWLOC_VER}"
          ./configure --enable-static --disable-shared \
            --disable-io --disable-libudev --disable-libxml2 \
            --disable-opencl --disable-cuda --disable-nvml --disable-rsmi \
            --disable-gl --disable-pci --prefix=/usr/local
          make -j$(nproc)
          sudo make install

      - name: Prepare static libraries
        run: |
          sudo ln -sf /usr/lib/x86_64-linux-gnu/libuv_a.a /usr/lib/x86_64-linux-gnu/libuv.a
          sudo rm -f /usr/lib/x86_64-linux-gnu/libuv.so*

      - name: Build XMRig (static, portable x86-64)
        run: |
          mkdir build && cd build
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_TLS=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_CUDA=OFF \
            -DXMRIG_DEPS=/usr/local \
            -DCMAKE_C_FLAGS="-maes -march=x86-64 -mtune=generic" \
            -DCMAKE_CXX_FLAGS="-maes -march=x86-64 -mtune=generic" \
            -DCMAKE_EXE_LINKER_FLAGS="-static"
          make -j$(nproc)

      - name: Verify and strip binary
        run: |
          BINARY=$(find build -maxdepth 1 -name "xmrig*" -type f -executable | head -1)
          echo "=== file ==="
          file "$BINARY"
          echo "=== ldd ==="
          ldd "$BINARY" 2>&1 || echo "(statically linked - OK)"
          echo "=== arch check ==="
          readelf -A "$BINARY" 2>/dev/null | head -20 || true
          objdump -d "$BINARY" | grep -c 'vbroadcast\|vperm\|vgather\|vaes' | xargs -I{} echo "AVX-512/VAES instructions found: {} (should be 0 for portable build)" || true
          strip "$BINARY"
          cp "$BINARY" build/xmrig
          echo "=== final size ==="
          ls -lh build/xmrig
          echo "=== smoke test ==="
          build/xmrig --version || true

      - name: Prepare HiveOS package
        run: |
          PKG_NAME="xmrig"
          PKG_DIR="package/$PKG_NAME"
          mkdir -p "$PKG_DIR"
          
          # Copy binary
          cp build/xmrig "$PKG_DIR/xmrig"
          chmod +x "$PKG_DIR/xmrig"
          
          # Copy HiveOS integration scripts
          cp hiveos/h-manifest.conf "$PKG_DIR/"
          cp hiveos/h-run.sh "$PKG_DIR/"
          cp hiveos/h-stats.sh "$PKG_DIR/"
          cp hiveos/h-config.sh "$PKG_DIR/"
          
          # Copy install helper
          if [ -f hiveos/install.sh ]; then cp hiveos/install.sh "$PKG_DIR/"; fi
          
          # Force LF line endings (safety net)
          sed -i 's/\r$//' "$PKG_DIR"/*.sh "$PKG_DIR"/*.conf
          
          chmod +x "$PKG_DIR"/*.sh
          
          # Verify scripts parse correctly
          bash -n "$PKG_DIR/h-run.sh" && echo "h-run.sh: syntax OK" || exit 1
          bash -n "$PKG_DIR/h-stats.sh" && echo "h-stats.sh: syntax OK" || exit 1
          
          # Create the tar.gz
          cd package
          tar -czf "xmrig-tari.tar.gz" "$PKG_NAME"
          
          echo "Package contents:"
          tar -tzf "xmrig-tari.tar.gz"
          echo ""
          ls -lh "xmrig-tari.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-tari-hiveos
          path: package/xmrig-tari.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: package/xmrig-tari.tar.gz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Create release-only static triplet
        run: |
          $tripletDir = "$env:VCPKG_INSTALLATION_ROOT\triplets\community"
          @"
          set(VCPKG_TARGET_ARCHITECTURE x64)
          set(VCPKG_CRT_LINKAGE static)
          set(VCPKG_LIBRARY_LINKAGE static)
          set(VCPKG_BUILD_TYPE release)
          "@ | Set-Content "$tripletDir\x64-windows-static-release.cmake"

      - name: Install libuv via vcpkg (static release only)
        run: |
          vcpkg install libuv:x64-windows-static-release

      - name: Build XMRig (Windows, fully static)
        run: |
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_INSTALLATION_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DVCPKG_TARGET_TRIPLET=x64-windows-static-release `
            -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
            -DWITH_TLS=OFF -DWITH_OPENCL=OFF -DWITH_CUDA=OFF -DWITH_HWLOC=OFF
          cmake --build . --config Release

      - name: Verify no DLL dependencies
        run: |
          $bin = Get-ChildItem build\Release\xmrig*.exe | Select-Object -First 1
          Write-Host "Binary: $($bin.FullName) ($([math]::Round($bin.Length/1MB,2)) MB)"
          # Check for uv.dll dependency - should NOT be present
          $deps = & dumpbin /dependents $bin.FullName 2>$null
          Write-Host "=== Dependencies ==="
          $deps | Where-Object { $_ -match '\.dll' } | ForEach-Object { Write-Host $_.Trim() }
          if ($deps | Where-Object { $_ -match 'uv\.dll' }) {
            Write-Error "FATAL: uv.dll dependency found - build is not static!"
            exit 1
          }
          Write-Host "OK: No uv.dll dependency"

      - name: Package Windows build
        run: |
          mkdir package
          $bin = Get-ChildItem build\Release\xmrig*.exe | Select-Object -First 1
          Copy-Item $bin.FullName package\xmrig-tari.exe

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: xmrig-tari-windows
          path: package/xmrig-tari.exe

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: package/xmrig-tari.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
